# Strengthening supply chain security: SBOMs and more

## Background

We all use third party software and libraries. OpenTofu has over 250 dependencies, not including any providers it uses and their dependencies. Any of these dependencies could have a vulnerability which could affect OpenTofu users. While the OpenTofu team keep track of dependencies and issues security updates as quick as possible, in a corporate environment simply trusting software vendors to do the right thing is not enough.

For a corporate software operator, ensuring that all known vulnerabilities in the software supply chain are addressed or mitigated has become increasingly important in recent years. In some situations, tracking these dependencies and their vulnerabilities is even [legally required](https://www.cisa.gov/executive-order-14017-securing-americas-supply-chains). Additionally, corporate operators often wish to also scan the supply chain for unacceptable licenses for their particular needs.

OpenTofu users today can already scan the OpenTofu binary as it contains a list of all dependencies built into it. Additionally, users can rely on both GPG and Cosign signatures to verify that the binary has not been tampered with since it was published.

However, we can still do more to make corporate operators' lives easier:

1. With the introduction of our proposed [custom OCI artifact format](https://github.com/opentofu/opentofu/pull/2163), the ability to simply scan the Go binary will become difficult as operators would need to implement custom unpacking.
2. Operators today have to manually download provider binaries and scan them should they want to list dependencies in providers.

While both of these points can be addressed by custom tooling, maintaining custom tooling, especially running OpenTofu registries is troublesome in a corporate environment and comes with its own compliance burden.

However, Software Bill of Materials artifact formats, such as the [SPDX JSON](https://github.com/spdx/spdx-spec/blob/development/v2.2.2/examples/SPDXJSONExample-v2.2.spdx.json), allow software vendors such as OpenTofu to publish a list of their dependencies and information related to them. Publishing SBOMs and other attestation artifacts is increasingly becoming the standard to address the aforementioned compliance concerns.

## Proposal

This RFC addresses the compliance concern in the following ways:

1. OpenTofu should publish a Software Bill of Materials (SBOM) artifact for the main OpenTofu binary that users can rely on to list OpenTofu's direct dependencies.
2. OpenTofu should make it possible to publish SBOM and SLSA attestation artifacts for providers and expose them in the OpenTofu Registry. 
3. OpenTofu should publish SBOM artifacts for the providers mirrored from the HashiCorp repositories (AWS, etc.)

For the current RFC, we consider out of scope:

- Module SBOM and other attestation artifacts are out of scope as there are currently no tools capable of generating them.
- Only SPDX JSON is considered in this document because it has a standardized MIME type. SPDX XML, SPDX YAML and CycloneDX are not considered because they do not have a standardized MIME type.
- SLSA provenance ([#315](https://github.com/opentofu/opentofu/issues/315)) is out of scope because it would make this RFC significantly more complex and is not required to achieve the goals outlined in the [OCI RFC](https://github.com/opentofu/opentofu/pull/2163). A later RFC can address SLSA support.

## 1. Publishing an SBOM for OpenTofu itself

OpenTofu today uses Goreleaser, which [already has support for generating SBOMs](https://goreleaser.com/customization/sbom/) using tools like [Syft](https://github.com/anchore/syft). Publishing an SBOM artifact is as simple as installing Syft in the release pipeline and including the following Goreleaser snippet:

```yaml
sboms:
  - id: SPDX
    documents:
      - "{{ .ProjectName }}_{{ .Version }}_{{ .Arch }}.spdx.json"
    artifacts: binary
```

## 2. Enabling publication of SBOM artifacts in the OpenTofu Registry

### Protocol changes

To support the discovery of SBOM artifacts, we propose changing the ["Find a Provider Package"](https://opentofu.org/docs/internals/provider-registry-protocol/#find-a-provider-package) endpoint located at `:namespace/:type/:version/download/:os/:arch` to include the `attachments` field:

```json
{
  "protocols": ["4.0", "5.1"],
  "os": "linux",
  "arch": "amd64",
  "filename": "terraform-provider-random_2.0.0_linux_amd64.zip",
  "download_url": "https://releases.example.com/terraform-provider-random/2.0.0/terraform-provider-random_2.0.0_linux_amd64.zip",
  "shasums_url": "https://releases.example.com/terraform-provider-random/2.0.0/terraform-provider-random_2.0.0_SHA256SUMS",
  "shasums_signature_url": "https://releases.example.com/terraform-provider-random/2.0.0/terraform-provider-random_2.0.0_SHA256SUMS.sig",
  "shasum": "5f9c7aa76b7c34d722fc9123208e26b22d60440cb47150dd04733b9b94f4541a",
  "signing_keys": {
    "gpg_public_keys": [
      {
        "key_id": "51852D87348FFC4C",
        "ascii_armor": "-----BEGIN PGP PUBLIC KEY BLOCK-----\nVersion: GnuPG v1\n\nmQENBFMO...",
        "trust_signature": "",
        "source": "ExampleCorp",
        "source_url": "https://www.examplecorp.com/security.html"
      }
    ]
  },
  "attachments": [
    {
      "media_type": "application/spdx+json",
      "filename": "sbom.spdx.json",
      "download_url": "https://releases.example.com/terraform-provider-random/2.0.0/sbom.spdx.json"
    }
  ]
}
```

The OpenTofu Registry should perform a *narrowly tailored* scan for SBOM and other attestation artifacts and include them in the `attachments` section according to the following rules:

- `*.spdx.json` and `*.spdx.sbom.json` (SPDX) will be identified as [`application/spdx+json`](https://www.iana.org/assignments/media-types/application/spdx+json)

However, we are currently excluding the following:

- `*.spdx.xml`, `*.spdx.yml`, and `*.spdx.yaml` (SPDX) will *not* be supported until [there is an approved MIME type for them](https://github.com/spdx/spdx-spec/issues/577#issuecomment-960295523)
- `bom.xml` and `bom.json` (CycloneDX) will *not* be supported [until there is an approved MIME type for it](https://github.com/CycloneDX/specification/issues/210)

These rules may be amended later if there is sufficient proof that a correct and unique MIME type has been established by the format vendor.

Since the response is a per-platform response, the OpenTofu registry should follow the naming rules for the provider binaries to determine if an attestation/SBOM artifact is related to a single platform or to all platforms. In the registry response both kinds of responses should be included. For example:

- `terraform-provider-aws_5.86.0_linux_arm.spdx.json` relates to the `linux/arm` platform
- `slsa.in-toto.jsonl` relates to all platforms

> [!NOTE]
> The [default Goreleaser configuration](https://goreleaser.com/customization/sbom/#usage) produces a file ending in `.sbom.json`. This will not be recognized as the OpenTofu Registry cannot automatically determine the correct MIME type from the filename alone. 

> [!WARNING]
> Clients wishing to use these attachments should verify their integrity by checking them against the SHA256SUMS file and, if present, the GPG signature.

### Registry Search changes

In addition to including such artifacts in the registry response, the [OpenTofu Registry Search](https://github.com/opentofu/registry-ui) should make a copy of these files after verifying their checksum and potential GPG key and expose them via the [OpenTofu API](https://api.opentofu.org). At this time, no user-facing feature is planned for these artifacts, but we encourage the community to submit proposals and pull requests to that end.

### Registry metadata changes

On the implementation side, this change will require a change in the [OpenTofu Registry](https://github.com/opentofu/registry) data format, which needs to be mirrored in [libregistry](https://github.com/opentofu/libregistry) as well. Specifically, both the `versions` and the `versions` &rarr; `targets` structures should be amended to include the same structure as the proposed `attachments` structure indicated above:

```json
{
  "versions": [
    {
      "version": "5.86.0",
      "protocols": [
        "6.0"
      ],
      "shasums_url": "...",
      "shasums_signature_url": "...",
      "targets": [
        {
          "os": "linux",
          "arch": "arm",
          "filename": "terraform-provider-random_5.86.0_linux_arm.zip",
          "download_url": "...",
          "shasum": "...",
          "attachments": [
            {
              "media_type": "application/spdx+json",
              "filename": "terraform-provider-random_5.86.0_linux_arm.spdx.json",
              "url": "..."
            }
          ]
        }
      ],
      "attachments": [
        {
          "media_type": "application/vnd.in-toto+json",
          "filename": "slsa.in-toto.jsonl",
          "url": "..."
        }
      ]
    }
  ]
}
```

### CLI changes

OpenTofu should offer the ability to download all attestations of a certain type into a local folder. For example:

```
tofu providers download-attachments --types=application/spdx+json,application/vnd.in-toto+json --destination=./attestations
```

This command would iterate over all providers in the current project and download attachments related to the providers used in the current project into the destination folder, grouped by provider name.

Most of the download code should be implemented in [libregistry](https://github.com/opentofu/libregistry) as it will also be needed for the mirroring tool proposed to the OCI registry RFC, as well as other tool vendors.

> [!NOTE]
> The implementation of the CLI command itself can be left as a stretch goal as it is not strictly necessary in the first step. This may be a good issue for a first-time contributor.

### Documentation changes

In addition to allowing for these artifacts to be published and downloaded, we should also update the [Registry documentation](https://search.opentofu.org/docs) and update the Provider Protocol documentation. In particular, the documentation should include:

- How to add Syft to the build pipeline
- How to change the default provider template Goreleaser file (including a warning against using the default configuration)
- How to produce a valid attachment artifact manually

## 3. Generating SBOM artifacts for HashiCorp providers

As with the main OpenTofu binary, HashiCorp providers use Goreleaser for the release process. Generating SBOMs will require the installation of Syft in GitHub Actions and adding the following to the `.goreleaser.yml` file in each repo:

```yaml
sboms:
  - id: SPDX
    documents:
      - "{{ .ProjectName }}_{{ .Version }}_{{ .Arch }}.spdx.json"
    artifacts: binary
```
